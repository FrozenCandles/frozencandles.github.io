<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>编辑器归档 - 冰封残烛的个人小站</title>
	<atom:link href="http://localhost/wordpress/archives/tag/%E7%BC%96%E8%BE%91%E5%99%A8/feed?simply_static_page=3797" rel="self" type="application/rss+xml" />
	<link></link>
	<description>FrozenCandle&#039;s Personal Site</description>
	<lastBuildDate>Mon, 12 Dec 2022 12:25:50 +0000</lastBuildDate>
	<language>zh-CN</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=6.2.1</generator>

<image>
	<url>/wp-content/uploads/2022/02/cropped-preview-2-150x150.jpg</url>
	<title>编辑器归档 - 冰封残烛的个人小站</title>
	<link></link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>CodeMirror实现Django后台代码编辑器</title>
		<link>/archives/82</link>
					<comments>/archives/82#respond</comments>
		
		<dc:creator><![CDATA[Hello]]></dc:creator>
		<pubDate>Sat, 12 Feb 2022 13:49:50 +0000</pubDate>
				<category><![CDATA[前端]]></category>
		<category><![CDATA[codemirror]]></category>
		<category><![CDATA[Django]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[编辑器]]></category>
		<guid isPermaLink="false">/?p=82</guid>

					<description><![CDATA[<p>在Django管理后台时，如果需要处理代码相关的内容&#46;&#46;&#46;</p>
<p><a rel="nofollow" href="/archives/82">CodeMirror实现Django后台代码编辑器</a>最先出现在<a rel="nofollow" href="">冰封残烛的个人小站</a>。</p>
]]></description>
										<content:encoded><![CDATA[
<p>在Django管理后台时，如果需要处理代码相关的内容（如为网站添加额外CSS），往往会需要嵌入一个简单的代码编辑器。</p>



<p>这里以CodeMirror为例介绍如何为Django后台提供一个代码编辑器。最终效果为：</p>



<figure class="wp-block-image size-large is-resized"><img decoding="async" src="/wp-content/uploads/2022/02/django-editor-finally-1024x590.png" alt="" class="wp-image-83" width="710" height="408" srcset="/wp-content/uploads/2022/02/django-editor-finally-1024x590.png 1024w, /wp-content/uploads/2022/02/django-editor-finally-300x173.png 300w, /wp-content/uploads/2022/02/django-editor-finally.png 1426w" sizes="(max-width: 710px) 100vw, 710px" /></figure>



<p>对于其余类似的富文本管理，解决方法是相似的。</p>



<p>涉及内容：</p>



<ul><li>Django</li><li>JavaScript</li></ul>



<hr class="wp-block-separator"/>



<h2 class="wp-block-heading" id="codemirror简介">CodeMirror简介</h2>



<h3 class="wp-block-heading" id="本地运行">本地运行</h3>



<p>CodeMirror是一个纯JavaScript实现的Web编辑器，与之类似的还有Ace editor，以及它的二次开发项目MDeditor。</p>



<p>CodePen等许多在线代码编辑网站使用的编辑器都是CodeMirror。基于CodeMirror，也可以使用MDeditor在后台直接编写基于Markdown的文章。</p>



<p>可以在CodeMirror官方网站 <a href="https://codemirror.net/" target="_blank" rel="noreferrer noopener">https://codemirror.net/</a> 下载到它的源码：</p>



<figure class="wp-block-image size-large is-resized"><img decoding="async" src="/wp-content/uploads/2022/02/django-editor-codemirror-1024x710.png" alt="" class="wp-image-84" width="596" height="413" srcset="/wp-content/uploads/2022/02/django-editor-codemirror-1024x710.png 1024w, /wp-content/uploads/2022/02/django-editor-codemirror-300x208.png 300w, /wp-content/uploads/2022/02/django-editor-codemirror-768x532.png 768w, /wp-content/uploads/2022/02/django-editor-codemirror.png 1042w" sizes="(max-width: 596px) 100vw, 596px" /><figcaption>注意下载按钮在太极图的左半部分</figcaption></figure>



<p>或者在GitHub上查看源码：<a href="https://github.com/codemirror/codemirror">https://github.com/codemirror/codemirror</a></p>



<p>将下载的源码解压，得到一个文件夹。在文件夹的同级目录下新建一个HTML文件，使用以下代码可以编写一个基本的代码编辑器：</p>



<div class="vscode-block" style="color: #236ebf;background-color: #ffffff;font-family: Consolas, 'Courier New', monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #3e3e3e;">&lt;!</span><span style="color: #0444ac;">DOCTYPE</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">html</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">html</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">head</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">meta</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">charset</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">UTF-8</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">title</span><span style="color: #3e3e3e;">&gt;</span><span style="color: #236ebf;">Document</span><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">title</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">link</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">rel</span><span style="color: #236ebf;">=</span><span style="color: #a44185;">stylesheet</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">href</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/lib/codemirror.css</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">src</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/lib/codemirror.js</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">src</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/mode/javascript/javascript.js</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">src</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/mode/css/css.js</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">src</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/mode/htmlmixed/htmlmixed.js</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">src</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/addon/edit/matchbrackets.js</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">head</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">body</span><span style="color: #3e3e3e;">&gt;</span></div><br><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">textarea</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">id</span><span style="color: #236ebf;">=</span><span style="color: #a44185;">code</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">textarea</span><span style="color: #3e3e3e;">&gt;</span></div><br><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #0991b6;font-weight: bold;">var</span><span style="color: #c792ea;"> </span><span style="color: #828282;">editor</span><span style="color: #c792ea;"> </span><span style="color: #7b30d0;">=</span><span style="color: #c792ea;"> </span><span style="color: #828282;">CodeMirror</span><span style="color: #c792ea;">.</span><span style="color: #b1108e;">fromTextArea</span><span style="color: #c792ea;">(</span><span style="color: #828282;">document</span><span style="color: #c792ea;">.</span><span style="color: #b1108e;">getElementById</span><span style="color: #c792ea;">(</span><span style="color: #d86db6;">'</span><span style="color: #a44185;">code</span><span style="color: #d86db6;">'</span><span style="color: #c792ea;">), </span><span style="color: #3e3e3e;">{</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; lineNumbers: </span><span style="color: #174781;">true</span><span style="color: #c792ea;">, &nbsp;</span><span style="color: #a8a8a8;">// 显示行号</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; lineWrapping: </span><span style="color: #174781;">true</span><span style="color: #c792ea;">, </span><span style="color: #a8a8a8;">// 强制换行</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; mode: </span><span style="color: #d86db6;">"</span><span style="color: #a44185;">text/html</span><span style="color: #d86db6;">"</span><span style="color: #c792ea;">, &nbsp;</span><span style="color: #a8a8a8;">// 代码类型</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; matchBrackets: </span><span style="color: #174781;">true</span><span style="color: #c792ea;"> </span><span style="color: #a8a8a8;">// 括号匹配</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">}</span><span style="color: #c792ea;">)</span><span style="color: #236ebf;">;</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">body</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">html</span><span style="color: #3e3e3e;">&gt;</span></div></div>



<p>在浏览器中打开该HTML文件，如果出现如下所示的编辑器，表示CodeMirror可以正常使用：</p>



<figure class="wp-block-image size-full is-resized"><img decoding="async" src="/wp-content/uploads/2022/02/django-editor-browser.png" alt="" class="wp-image-86" width="611" height="296"/><figcaption>运行效果</figcaption></figure>



<p>该编辑器默认可以高亮HTML代码、括号对和不匹配的HTML标签。</p>



<h3 class="wp-block-heading" id="编辑器简单配置">编辑器简单配置</h3>



<p>完整的使用手册可以在CodeMirror的官网查阅。这里仅介绍一些基本的配置。</p>



<p>一个基本的代码编辑器需要包含 <span class="sfile">lib/codemirror.css</span> 和 <span class="sfile">lib/codemirror.js</span> 两个文件。<span class="sfile">mode</span> 目录下的文件用于为编辑器添加编程语言支持；<span class="sfile">addon</span> 目录下的文件为编辑器附带额外功能；<span class="sfile">theme</span> 目录下的文件可以更改代码高亮的颜色主题。</p>



<p><code class="traditional">editor</code> 变量从一个 <code class="traditional">&lt;textarea&gt;</code> DOM结点中得到了一个变量，第二个参数是一些初始化配置。可以对该变量调用一些方法来动态更改编辑器的一些属性。常用的有：<code class="traditional">editor.setOption("<em>option</em>","<em>value</em>");</code> 修改配置，<code class="traditional">editor.setSize(<em>width</em>, <em>height</em>)</code> 改变大小。</p>



<p>以下示例在编辑器的HTML代码做了一些配置：</p>



<div class="vscode-block" style="color: #236ebf;background-color: #ffffff;font-family: 'Consolas NF', 'CodeNewRoman NF', Consolas, 'Courier New', monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">src</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/mode/python/python.js</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">link</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">rel</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">stylesheet</span><span style="color: #d86db6;">"</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">href</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">codemirror/theme/lesser-dark.css</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">style</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #df8618;">.CodeMirror.CodeMirror-wrap.cm-s-lesser-dark</span><span style="color: #236ebf;"> {</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #dc3eb7;">border</span><span style="color: #236ebf;">: </span><span style="color: #174781;">1</span><span style="color: #0991b6;">px</span><span style="color: #236ebf;"> </span><span style="color: #174781;">solid</span><span style="color: #236ebf;"> </span><span style="color: #2970c7;">#ccc</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #dc3eb7;">border-radius</span><span style="color: #236ebf;">: </span><span style="color: #174781;">5</span><span style="color: #0991b6;">px</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #dc3eb7;">width</span><span style="color: #236ebf;">: </span><span style="color: #174781;">70</span><span style="color: #0991b6;">%</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #dc3eb7;">overflow-x</span><span style="color: #236ebf;">: </span><span style="color: #174781;">hidden</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; }</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #df8618;">.CodeMirror-linenumber.CodeMirror-gutter-elt</span><span style="color: #236ebf;">, </span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #0444ac;">span</span><span style="color: #236ebf;">[</span><span style="color: #df8618;">role</span><span style="color: #7b30d0;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">presentation</span><span style="color: #d86db6;">"</span><span style="color: #236ebf;">] {</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #dc3eb7;">font-family</span><span style="color: #236ebf;">: Consolas, </span><span style="color: #d86db6;">"</span><span style="color: #a44185;">Courier New</span><span style="color: #d86db6;">"</span><span style="color: #236ebf;">, </span><span style="color: #174781;">Courier</span><span style="color: #236ebf;">, </span><span style="color: #174781;">monospace</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #dc3eb7;">font-size</span><span style="color: #236ebf;">: </span><span style="color: #174781;">14</span><span style="color: #0991b6;">px</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; }</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">style</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #0991b6;font-weight: bold;">var</span><span style="color: #c792ea;"> </span><span style="color: #828282;">editor</span><span style="color: #c792ea;"> </span><span style="color: #7b30d0;">=</span><span style="color: #c792ea;"> </span><span style="color: #828282;">CodeMirror</span><span style="color: #c792ea;">.</span><span style="color: #b1108e;">fromTextArea</span><span style="color: #c792ea;">(</span><span style="color: #828282;">document</span><span style="color: #c792ea;">.</span><span style="color: #b1108e;">getElementById</span><span style="color: #c792ea;">(</span><span style="color: #d86db6;">'</span><span style="color: #a44185;">code</span><span style="color: #d86db6;">'</span><span style="color: #c792ea;">), </span><span style="color: #3e3e3e;">{</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; lineNumbers: </span><span style="color: #174781;">true</span><span style="color: #c792ea;">, </span><span style="color: #a8a8a8;">// 是否显示行号</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; mode:</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">python</span><span style="color: #d86db6;">"</span><span style="color: #c792ea;">, &nbsp; &nbsp; </span><span style="color: #a8a8a8;">// 默认脚本编码</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; lineWrapping:</span><span style="color: #174781;">true</span><span style="color: #c792ea;">, </span><span style="color: #a8a8a8;">// 是否强制换行</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; matchBrackets: </span><span style="color: #174781;">true</span><span style="color: #c792ea;">,</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">}</span><span style="color: #c792ea;">)</span><span style="color: #236ebf;">;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #828282;">editor</span><span style="color: #236ebf;">.</span><span style="color: #b1108e;">setSize</span><span style="color: #236ebf;">(</span><span style="color: #174781;">550</span><span style="color: #236ebf;">, </span><span style="color: #2970c7;">null</span><span style="color: #236ebf;">);</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #828282;">editor</span><span style="color: #236ebf;">.</span><span style="color: #b1108e;">setOption</span><span style="color: #236ebf;">(</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">theme</span><span style="color: #d86db6;">"</span><span style="color: #236ebf;">, </span><span style="color: #d86db6;">"</span><span style="color: #a44185;">lesser-dark</span><span style="color: #d86db6;">"</span><span style="color: #236ebf;">) &nbsp;</span><span style="color: #a8a8a8;">// just an example</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div></div>



<p>配置完成后，编辑器的效果为：</p>



<figure class="wp-block-image size-full is-resized"><img decoding="async" src="/wp-content/uploads/2022/02/django-editor-modified.png" alt="" class="wp-image-87" width="597" height="329" srcset="/wp-content/uploads/2022/02/django-editor-modified.png 705w, /wp-content/uploads/2022/02/django-editor-modified-300x166.png 300w" sizes="(max-width: 597px) 100vw, 597px" /></figure>



<h2 class="wp-block-heading" id="应用到django后台">应用到Django后台</h2>



<h3 class="wp-block-heading" id="设计组件">设计组件</h3>



<p>要在Django后台中应用自定义的编辑器，最好的方法是编写自定义控件替换默认的 <code class="traditional">&lt;textarea&gt;</code> 或 <code class="traditional">&lt;input&gt;</code> 。在应用文件夹 <span class="sfile"><em>app</em></span><span class="sfile"></span> 下新建 <span class="sfile">widgets.py</span> ，存放所有的组件类：</p>



<div class="vscode-block" style="color: #403f53;background-color: #fbfbfb;font-family: 'Consolas NF', 'CodeNewRoman NF', Consolas, 'Courier New', monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #a8a8a8;"># widgets.py</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django.forms </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> Textarea</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django.template.loader </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> render_to_string</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django.utils.encoding </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> force_str</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django.utils.html </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> conditional_escape</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django.utils.safestring </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> mark_safe</span></div><br><div><span style="color: #994cc3;font-weight: bold;">class</span><span style="color: #403f53;"> </span><span style="color: #111111;">EditorWidget</span><span style="color: #403f53;">(</span><span style="color: #4876d6;">Textarea</span><span style="color: #403f53;">):</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; </span><span style="color: #994cc3;font-weight: bold;">class</span><span style="color: #403f53;"> </span><span style="color: #111111;">Media</span><span style="color: #403f53;">:</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; css </span><span style="color: #994cc3;">=</span><span style="color: #403f53;"> {</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">all</span><span style="color: #111111;">'</span><span style="color: #403f53;">: (</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/lib/codemirror.css</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; js </span><span style="color: #994cc3;">=</span><span style="color: #403f53;"> (</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/lib/codemirror.js</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/mode/xml/xml.js</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/mode/javascript/javascript.js</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/mode/css/css.js</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/mode/htmlmixed/htmlmixed.js</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">assets/codemirror/addon/edit/matchbrackets.js</span><span style="color: #111111;">'</span><span style="color: #403f53;">,</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; )</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; </span><span style="color: #994cc3;font-weight: bold;">def</span><span style="color: #403f53;"> </span><span style="color: #4876d6;">render</span><span style="color: #111111;">(</span><span style="color: #4876d6;">self</span><span style="color: #403f53;">, </span><span style="color: #4876d6;">name</span><span style="color: #403f53;">, </span><span style="color: #4876d6;">value</span><span style="color: #403f53;">, </span><span style="color: #4876d6;">renderer</span><span style="color: #994cc3;">=</span><span style="color: #bc5454;">None</span><span style="color: #403f53;">, </span><span style="color: #4876d6;">attrs</span><span style="color: #994cc3;">=</span><span style="color: #bc5454;">None</span><span style="color: #111111;">)</span><span style="color: #403f53;">:</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #994cc3;font-weight: bold;">if</span><span style="color: #403f53;"> value </span><span style="color: #994cc3;">is</span><span style="color: #403f53;"> </span><span style="color: #bc5454;">None</span><span style="color: #403f53;">:</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value </span><span style="color: #994cc3;">=</span><span style="color: #403f53;"> </span><span style="color: #111111;">''</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #994cc3;font-weight: bold;">return</span><span style="color: #403f53;"> </span><span style="color: #0c969b;">mark_safe</span><span style="color: #403f53;">(</span><span style="color: #0c969b;">render_to_string</span><span style="color: #403f53;">(</span><span style="color: #111111;">'</span><span style="color: #c96765;">frame/editor.html</span><span style="color: #111111;">'</span><span style="color: #4876d6;">, {</span></div><div><span style="color: #4876d6;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">value</span><span style="color: #111111;">'</span><span style="color: #4876d6;">: </span><span style="color: #0c969b;">conditional_escape</span><span style="color: #403f53;">(</span><span style="color: #0c969b;">force_str</span><span style="color: #403f53;">(</span><span style="color: #4876d6;">value</span><span style="color: #403f53;">))</span><span style="color: #4876d6;">,</span></div><div><span style="color: #4876d6;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #111111;">'</span><span style="color: #c96765;">name</span><span style="color: #111111;">'</span><span style="color: #4876d6;">: name</span></div><div><span style="color: #4876d6;">&nbsp; &nbsp; &nbsp; &nbsp; }</span><span style="color: #403f53;">))</span></div></div>



<p>这里自定义的组件类基于 <code class="traditional">&lt;textarea&gt;</code> ，元类 <code class="traditional">Media</code> 声明了组件需要用到的所有额外 CSS 和 JS 资源。注意，<code class="traditional">js</code> 属性只需要简单包含所有文件即可，而 <code class="traditional">css</code> 字典则确定对于不同媒体分别应用哪些 CSS 。Django会将这些静态资源提前安排在<code class="traditional"></code>网页的 <code class="traditional">&lt;head&gt;</code> 中。</p>



<p>注意这些资源需要放在静态资源文件夹下。如果不确定需要放在哪里，可以调用一个实例的 <code class="traditional">.media</code> 属性查询实际引用的URL路径：</p>



<div class="dcons"><span class="svenv">(http)</span> PS D:\Http\server\django_demo&gt; <span class="scomd">py</span> -u manage.py shell<br>
(InteractiveConsole)<br>
&gt;&gt;&gt; from app.widgets import EditorWidget<br>
&gt;&gt;&gt; w = EditorWidget()<br>
&gt;&gt;&gt; print(w.media)<br>
&lt;link href="/static/assets/codemirror/lib/codemirror.css" type="text/css" media="all" rel="stylesheet"&gt;<br>
&lt;script src="/static/assets/codemirror/lib/codemirror.js"&gt;&lt;/script&gt;<br>
&lt;script src="/static/assets/codemirror/mode/xml/xml.js"&gt;&lt;/script&gt;<br>
&lt;script src="/static/assets/codemirror/mode/javascript/javascript.js"&gt;&lt;/script&gt;<br>
&lt;script src="/static/assets/codemirror/mode/css/css.js"&gt;&lt;/script&gt;<br>
&lt;script src="/static/assets/codemirror/mode/htmlmixed/htmlmixed.js"&gt;&lt;/script&gt;<br>
&lt;script src="/static/assets/codemirror/addon/edit/matchbrackets.js"&gt;&lt;/script&gt;
</div>



<p>对于一个自定义的组件，最重要的就是重写 <code class="traditional">.render()</code> 方法。该方法决定了组件会生成如何的HTML代码。<code class="traditional">name</code> 参数为组件对应表单字段的 <code class="traditional">name</code> 值，为不同字段做区分；<code class="traditional">value</code> 参数为组件对应表单字段的 <code class="traditional">value</code> 值，负责提交这些数据。由于Django后台的组件既需要发送数据到服务端，也需要接收服务端发来的数据，因此需要根据这两个参数生成合适的表单元素。</p>



<p>这里将模板代码单独存放，使用 <code class="traditional">render_to_string()</code> 函数配合传入的上下文生成合适的HTML片段：</p>



<div class="vscode-block" style="color: #236ebf;background-color: #ffffff;font-family: Consolas, 'Courier New', monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #a8a8a8;">{# templates/frame/editor.html #}</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">div</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">id</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">editor</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">textarea</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">id</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">code</span><span style="color: #d86db6;">"</span><span style="color: #236ebf;"> </span><span style="color: #df8618;">name</span><span style="color: #236ebf;">=</span><span style="color: #d86db6;">"</span><span style="color: #a44185;">{{ name }}</span><span style="color: #d86db6;">"</span><span style="color: #3e3e3e;">&gt;</span><span style="color: #236ebf;">{% </span><span style="color: #0991b6;font-weight: bold;">if</span><span style="color: #236ebf;"> </span><span style="color: #2f86d2;">value</span><span style="color: #236ebf;"> %}{{ </span><span style="color: #2f86d2;">value</span><span style="color: #236ebf;"> }}{% </span><span style="color: #0991b6;font-weight: bold;">endif</span><span style="color: #236ebf;"> %}</span><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">textarea</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">div</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #3e3e3e;">&lt;</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div><div><span style="color: #236ebf;">&nbsp; &nbsp; </span><span style="color: #0991b6;font-weight: bold;">var</span><span style="color: #c792ea;"> </span><span style="color: #828282;">editor</span><span style="color: #c792ea;"> </span><span style="color: #7b30d0;">=</span><span style="color: #c792ea;"> </span><span style="color: #828282;">CodeMirror</span><span style="color: #c792ea;">.</span><span style="color: #b1108e;">fromTextArea</span><span style="color: #c792ea;">(</span><span style="color: #828282;">document</span><span style="color: #c792ea;">.</span><span style="color: #b1108e;">getElementById</span><span style="color: #c792ea;">(</span><span style="color: #d86db6;">'</span><span style="color: #a44185;">code</span><span style="color: #d86db6;">'</span><span style="color: #c792ea;">), </span><span style="color: #3e3e3e;">{</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; lineNumbers: </span><span style="color: #174781;">true</span><span style="color: #c792ea;">,</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; lineWrapping:</span><span style="color: #174781;">true</span><span style="color: #c792ea;">, </span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; mode: </span><span style="color: #d86db6;">"</span><span style="color: #a44185;">text/html</span><span style="color: #d86db6;">"</span><span style="color: #c792ea;">, </span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; &nbsp; &nbsp; matchBrackets: </span><span style="color: #174781;">true</span></div><div><span style="color: #c792ea;">&nbsp; &nbsp; </span><span style="color: #3e3e3e;">}</span><span style="color: #c792ea;">)</span><span style="color: #236ebf;">;</span></div><div><span style="color: #3e3e3e;">&lt;/</span><span style="color: #0444ac;">script</span><span style="color: #3e3e3e;">&gt;</span></div></div>



<h3 class="wp-block-heading" id="创建表单">创建表单</h3>



<p>如果要把组件应用到后台，需要作为一个表单中一个合适的字段。这里新建一个表单类，用包含自定义组件的字段替换原有的字段：</p>



<div class="vscode-block" style="color: #403f53;background-color: #fbfbfb;font-family: Consolas, 'Courier New', monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #a8a8a8;"># forms.py</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> forms</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> .widgets </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> EditorWidget</span></div><br><div><span style="color: #994cc3;font-weight: bold;">class</span><span style="color: #403f53;"> </span><span style="color: #111111;">EditorForm</span><span style="color: #403f53;">(</span><span style="color: #4876d6;">forms.ModelForm</span><span style="color: #403f53;">):</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; body </span><span style="color: #994cc3;">=</span><span style="color: #403f53;"> </span><span style="color: #0c969b;">forms.CharField</span><span style="color: #403f53;">(</span><span style="color: #4876d6;">required</span><span style="color: #994cc3;">=</span><span style="color: #bc5454;">True</span><span style="color: #4876d6;">, widget</span><span style="color: #994cc3;">=</span><span style="color: #4876d6;">EditorWidget</span><span style="color: #403f53;">)</span></div></div>



<p>注意，Django后台编辑一个 <code class="traditional">Model</code> 时，其表单对应Django内的 <code class="traditional">ModelForm</code> 类。</p>



<h3 class="wp-block-heading" id="应用到后台">应用到后台</h3>



<p>最后一步，将得到的表单应用到 <code class="traditional">ModelAdmin</code> 站点上，替换原有的 <code class="traditional">.form</code> 值。</p>



<div class="vscode-block" style="color: #403f53;background-color: #fbfbfb;font-family: Consolas, 'Courier New', monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #a8a8a8;"># admin.py</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> django.contrib </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> admin</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> .models </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> ArticleModel</span></div><div><span style="color: #994cc3;font-weight: bold;">from</span><span style="color: #403f53;"> .forms </span><span style="color: #994cc3;font-weight: bold;">import</span><span style="color: #403f53;"> EditorForm</span></div><br><div><span style="color: #403f53;">@</span><span style="color: #4876d6;">admin.register</span><span style="color: #403f53;">(ArticleModel)</span></div><div><span style="color: #994cc3;font-weight: bold;">class</span><span style="color: #403f53;"> </span><span style="color: #111111;">ArticleAdmin</span><span style="color: #403f53;">(</span><span style="color: #4876d6;">admin.ModelAdmin</span><span style="color: #403f53;">):</span></div><div><span style="color: #403f53;">&nbsp; &nbsp; form </span><span style="color: #994cc3;">=</span><span style="color: #403f53;"> EditorForm</span></div></div>



<p>以上步骤完成后，等Django更新服务后刷新后台，即可使用基于CodeMirror的代码编辑器了：</p>



<figure class="wp-block-image size-large is-resized"><img decoding="async" src="/wp-content/uploads/2022/02/django-editor-finally-1024x590.png" alt="" class="wp-image-83" width="710" height="408" srcset="/wp-content/uploads/2022/02/django-editor-finally-1024x590.png 1024w, /wp-content/uploads/2022/02/django-editor-finally-300x173.png 300w, /wp-content/uploads/2022/02/django-editor-finally.png 1426w" sizes="(max-width: 710px) 100vw, 710px" /></figure>



<h2 class="wp-block-heading" id="最后">最后</h2>



<h3 class="wp-block-heading" id="注意">注意</h3>



<p>在后台与服务器交换数据时，数据会在表单中交互，因此注意生成表单时字段需要给定正确的 <code class="traditional">name</code> 属性，否则数据无法正确显示与提交</p>



<p>CodeMirror编辑器会在生成时，提取 <code class="traditional">&lt;textarea&gt;</code> 中的数据作为编辑器的初始代码；并在表单提交时，将编辑器的数据实时更新到 <code class="traditional">&lt;textarea&gt;</code> 中。这也就是为什么编辑器不在 <code class="traditional">&lt;textarea&gt;</code> 中操作，但是后台可以正确与编辑器同步数据。</p>



<h3 class="wp-block-heading" id="延伸阅读">延伸阅读</h3>



<p>CodeMirror用户参考手册：</p>



<p><a href="https://codemirror.net/doc/manual.html">https://codemirror.net/doc/manual.html</a></p>



<p>Django文档中关于此部分的内容：</p>



<p><a href="https://docs.djangoproject.com/en/4.0/ref/forms/api/">https://docs.djangoproject.com/en/4.0/ref/forms/api/</a></p>



<p><a href="https://docs.djangoproject.com/en/4.0/ref/forms/widgets/">https://docs.djangoproject.com/en/4.0/ref/forms/widgets/</a></p>



<p><a href="https://docs.djangoproject.com/en/4.0/topics/forms/media/">https://docs.djangoproject.com/en/4.0/topics/forms/media/</a></p>
<p><a rel="nofollow" href="/archives/82">CodeMirror实现Django后台代码编辑器</a>最先出现在<a rel="nofollow" href="">冰封残烛的个人小站</a>。</p>
]]></content:encoded>
					
					<wfw:commentRss>/archives/82/feed</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
	</channel>
</rss>
